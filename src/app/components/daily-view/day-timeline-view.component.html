<div class="timeline-container">

  <!-- Timeline Header (Sticky) -->
  <div class="timeline-header">
    <!-- Ruler -->
    <div class="ruler-row">
      <div class="resource-header">
        <span class="header-label">Empleado</span>
      </div>
      <div class="ruler-track"
           (mousemove)="onTimelineMouseMove($event)"
           (mouseleave)="onTimelineMouseLeave()">

        <!-- Markers: 24h -->
        <div class="markers-container">
           @for(h of hours; track h; let i = $index) {
             @if(i < 24) {
                <div class="hour-block">
                  @if(h % 6 === 0) {
                     <span class="time-label dominant">{{ h }}:00</span>
                  } @else {
                     <span class="time-label">{{ h }}:00</span>
                  }
                  <div class="tick-mark"></div>
                  <!-- Micro-ticks for 15 mins (CSS) -->
                </div>
             }
           }
           <!-- 24:00 Marker -->
           <div class="hour-block end-marker">
              <span class="time-label dominant">24:00</span>
              <div class="tick-mark"></div>
           </div>
        </div>

        <!-- Hover Cursor -->
        @if(hoverTime()) {
          <div class="hover-cursor" [style.left.%]="hoverX()">
            <div class="cursor-tooltip">
              <div class="tooltip-time">{{ hoverTime() }}</div>
              <div class="tooltip-info">{{ getReducedActiveStaffString() }}</div>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- Coverage Track -->
    <div class="coverage-row">
       <div class="coverage-header">
         <span class="coverage-label">Cobertura</span>
       </div>
       <div class="coverage-track">
         @for(bucket of shiftService.dailyCoverage(); track bucket.time; let i = $index) {
           <div class="coverage-bucket"
                [class.has-staff]="bucket.count > 0"
                [class.no-staff]="bucket.count === 0"
                [title]="bucket.timeStr + ': ' + bucket.count + ' staff'"
                (click)="openCoverageDetails(bucket)">
           </div>
         }
       </div>
    </div>
  </div>

  <!-- Main Scrollable Area -->
  <div class="scroll-area custom-scrollbar">

    @for(group of groupedStaff(); track group.role) {
      <div class="group-header" (click)="toggleGroup(group.role)">
        <div class="group-title-cell">
          <span class="material-symbols-outlined transform transition-transform"
                [class.-rotate-90]="isGroupCollapsed(group.role)">
            expand_more
          </span>
          <span class="group-name">{{ group.role }} ({{ group.members.length }})</span>
        </div>
        <div class="group-track-cell"></div>
      </div>

      @if(!isGroupCollapsed(group.role)) {
        @for(staff of group.members; track staff.id) {
          <div class="timeline-row group-row">

          <!-- Resource Info -->
          <div class="resource-cell cursor-pointer hover:bg-slate-100" (click)="openPersonDetails(staff)">
             <div class="avatar-circle">
               {{ staff.fullName.substring(0,2) }}
             </div>
             <div class="resource-details">
               <p class="resource-name">{{ staff.fullName }}</p>
               <div class="resource-meta">
                 <span class="role-text">{{ staff.role }}</span>
                 <!-- Monthly hours (Mocked display) -->
                 <span class="hours-badge">{{ staff.monthlyHours }}h</span>
               </div>
             </div>
          </div>

          <!-- Timeline Lane -->
          <div class="timeline-lane"
               (mousemove)="onTimelineMouseMove($event)"
               (mouseleave)="onTimelineMouseLeave()"
               (click)="onLaneClick($event, staff.id)">

             <!-- Grid Lines (Every Hour) -->
             <div class="lane-grid">
                @for(h of hours; track h) {
                   @if(h < 24) {
                     <div class="grid-line">
                        <div class="sub-grid-line"></div>
                        <div class="sub-grid-line"></div>
                        <div class="sub-grid-line"></div>
                     </div>
                   }
                }
             </div>

             <!-- Shifts -->
             @for(shift of shiftsMap().get(staff.id); track shift.id) {
               <!-- Only render if not being dragged currently (optional, here we keep original until drop) -->
               <div class="shift-bar"
                    [ngStyle]="getShiftStyle(shift)"
                    [class.type-exception]="shift.type === 'exception'"
                    [class.type-overtime]="shift.type === 'overtime'"
                    [class.is-draft]="shift.status === 'draft'"
                    (mousedown)="startDrag($event, shift, 'move')"
                    (click)="openEditDialog(shift, $event)">

                  <!-- Resize Handles -->
                  <div class="resize-handle left" (mousedown)="startDrag($event, shift, 'resize-start')"></div>

                  <div class="shift-content">
                    <span class="shift-text">{{ shift.start }} - {{ shift.end }}</span>
                    @if(shift.status === 'draft') { <span class="draft-indicator"></span> }
                  </div>

                  <div class="resize-handle right" (mousedown)="startDrag($event, shift, 'resize-end')"></div>
               </div>
             }

             <!-- Drag Ghost -->
             @if(isDragging() && draggedShift()?.staffId === staff.id) {
               <div class="shift-ghost" [ngStyle]="getGhostStyle()">
                  <span class="ghost-label">{{ dragGhost()?.start }} - {{ dragGhost()?.end }}</span>
               </div>
             }

          </div>
        </div>
        }
      }
    }
  </div>

  <app-shift-edit-dialog
    [isOpen]="isDialogOpen()"
    [shift]="selectedShift()"
    [isNewEntry]="isNewEntry()"
    (closeEvent)="closeDialog()"
    (saveEvent)="saveShift($event)"
    (deleteEvent)="deleteShift($event)">
  </app-shift-edit-dialog>

  <app-person-details-dialog
    [isOpen]="isPersonDialogOpen()"
    [staff]="selectedPerson()"
    (closeEvent)="closePersonDialog()">
  </app-person-details-dialog>

  <app-coverage-details-dialog
    [isOpen]="isCoverageDialogOpen()"
    [time]="coverageTime()"
    [staffList]="coverageStaffList()"
    [roleBreakdown]="coverageBreakdown()"
    (closeEvent)="closeCoverageDialog()">
  </app-coverage-details-dialog>

</div>
